meta:
    paths:
        'nfnty': 'images'

    repos: [
        'nfnty',
        'core',
        'extra',
        'community',
    ]

    params:
        # 1GiB
        'memory': 1073741824
        'memswap': -1
        'cpushares': 128

    limits:
        threads: 8
        timeout: 30

    headers:
        user-agent: 'Mozilla/5.0 (X11; Linux x86_64; rv:43.0) Gecko/20100101 Firefox/43.0'

    globals:
        'xpath_arch': &XPATH_ARCH '//div[@itemtype="http://schema.org/SoftwareApplication"]/meta[@itemprop="version"]'
        'attribute_arch': &ATTRIBUTE_ARCH 'content'
        'regex_ver_2num': &REGEX_VER_2NUM '(\d+\.\d+)'
        'regex_ver_3num': &REGEX_VER_3NUM '(\d+\.\d+\.\d+)'
        'regex_ver_3num_vtag': &REGEX_VER_3NUM_VTAG '^v(\d+\.\d+\.\d+)$'
        'regex_ver_4num': &REGEX_VER_4NUM '(\d+\.\d+\.\d+\.\d+)'

#################
#  BASE IMAGES  #
#################

'nfnty/arch-mini:latest':
    build: True
    scratch:
        call: 'containers/bootstrap/run.sh'
        args: [
            'bootstrap',
        ]

'nfnty/arch-devel:latest':
    build: False

'nfnty/arch-jre8:latest':
    build: False
    packages:
        'jre8-openjdk-headless':
            variable: 'VERSION_JAVA'
            download: 'extra'
            sources:
                upstream:
                    url: 'http://openjdk.java.net/projects/jdk8u'
                    xpath: '(//li[text()[contains(., "Released")]])[1]/a[1]'
                    regex: '(\du\d+)'
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/jre8-openjdk-headless'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-mono:latest':
    build: False
    packages:
        'mono':
            variable: 'VERSION_MONO'
            download: 'extra'
            sources:
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/mono'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-python:latest':
    build: True
    packages:
        'python':
            variable: 'VERSION_PYTHON'
            download: 'extra'
            sources:
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/python'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-python2:latest':
    build: True
    packages:
        'python2':
            variable: 'VERSION_PYTHON2'
            download: 'extra'
            sources:
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/python2'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

######################
#  CONTAINER IMAGES  #
######################

'nfnty/arch-bootstrap:latest':
    build: True

'nfnty/arch-builder:latest':
    build: True

'nfnty/arch-dovecot:latest':
    build: True
    packages:
        'dovecot':
            variable: 'VERSION_DOVECOT'
            download: 'extra'
            sources:
                upstream:
                    url: 'http://dovecot.org/download.html'
                    xpath: '(//h3[text()="Stable releases"]/following-sibling::ul/li/a)[1]'
                    regex: *REGEX_VER_3NUM
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/dovecot'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-elasticsearch:latest':
    build: True
    packages:
        'elasticsearch':
            variable: 'VERSION_ELASTICSEARCH'
            download: 'upstream'
            sources:
                upstream:
                    url: 'https://www.elastic.co/downloads/elasticsearch'
                    xpath: '(//div[contains(@class, "download-content-wrapper")]/header/h2)[1]'
                    regex: *REGEX_VER_3NUM
                github:
                    url: 'https://github.com/elastic/elasticsearch/tags'
                    xpath: '//span[@class="tag-name"]'
                    regex: *REGEX_VER_3NUM_VTAG

'nfnty/arch-emby:latest':
    build: True
    packages:
        'emby-server':
            variable: 'VERSION_EMBY'
            download: 'community'
            sources:
                github:
                    url: 'https://github.com/MediaBrowser/Emby/releases'
                    xpath: '//div[@class="release label-latest"]//h1[@class="release-title"]/a'
                    regex: '(\d+\.\d+\.\d+(?:\.\d+)?)'

'nfnty/arch-exim:latest':
    build: True
    packages:
        'exim':
            variable: 'VERSION_EXIM'
            download: 'nfnty'
            sources:
                upstream:
                    url: 'http://exim.org/index.html'
                    xpath: '//div[@id="content"]/h2[contains(text(), "Latest Version")]'
                    regex: *REGEX_VER_2NUM
                archlinux:
                    url: 'https://www.archlinux.org/packages/community/x86_64/exim'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-heka:latest':
    build: True
    packages:
        'heka':
            variable: 'VERSION_HEKA'
            download: 'nfnty'
            sources:
                github:
                    url: 'https://github.com/mozilla-services/heka/tags'
                    xpath: '//span[@class="tag-name"]'
                    regex: *REGEX_VER_3NUM_VTAG


'nfnty/arch-hostapd:latest':
    build: True
    packages:
        'hostapd':
            variable: 'VERSION_HOSTAPD'
            download: 'nfnty'
            sources:
                upstream:
                    url: 'https://w1.fi/hostapd'
                    xpath: '//li[contains(text(), "Latest release")]//a'
                    regex: *REGEX_VER_2NUM
                archlinux:
                    url: 'https://www.archlinux.org/packages/community/x86_64/hostapd'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-kea:latest':
    build: True
    packages:
        'kea':
            variable: 'VERSION_KEA'
            download: 'nfnty'
            sources:
                upstream:
                    url: 'http://ftp.isc.org/isc/kea'
                    xpath: '//table[@id="indexlist"]//td[@class="indexcolname"]/a'
                    regex: '^(\d+\.\d+(?:\.\d+)?)/$'

'nfnty/arch-kibana:latest':
    build: True
    packages:
        'kibana':
            variable: 'VERSION_KIBANA'
            download: 'upstream'
            sources:
                upstream:
                    url: 'https://www.elastic.co/downloads/kibana'
                    xpath: '(//div[contains(@class, "download-content-wrapper")]/header/h2)[1]'
                    regex: *REGEX_VER_3NUM
                github:
                    url: 'https://github.com/elastic/kibana/tags'
                    xpath: '//span[@class="tag-name"]'
                    regex: *REGEX_VER_3NUM_VTAG

'nfnty/arch-logstash:latest':
    build: True
    packages:
        'logstash':
            variable: 'VERSION_LOGSTASH'
            download: 'upstream'
            sources:
                upstream:
                    url: 'https://www.elastic.co/downloads/logstash'
                    xpath: '(//div[contains(@class, "download-content-wrapper")]/header/h2)[1]'
                    regex: *REGEX_VER_3NUM
                github:
                    url: 'https://github.com/elastic/logstash/tags'
                    xpath: '//span[@class="tag-name"]'
                    regex: *REGEX_VER_3NUM_VTAG

'nfnty/arch-nginx:latest':
    build: True
    packages:
        'nginx':
            variable: 'VERSION_NGINX'
            download: 'extra'
            sources:
                upstream:
                    url: 'http://nginx.org/en/download.html'
                    xpath: '((//h4[text()="Stable version"]/../following-sibling::table)[1]//a[contains(@href, "tar.gz")])[1]'
                    regex: '^nginx-(\d+\.\d+\.\d+)$'
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/nginx'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-nginx-php:latest':
    build: True
    packages:
        'php':
            variable: 'VERSION_PHP'
            download: 'extra'
            sources:
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/php'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-ntp:latest':
    build: True
    packages:
        'ntp':
            variable: 'VERSION_NTP'
            download: 'nfnty'
            sources:
                upstream:
                    url: 'http://www.ntp.org/downloads.html'
                    xpath: '(//th[text()="Production"]/following-sibling::td)[1]'
                    regex: '^(\d+\.\d+\.\d+(?:.+)?)$'
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/ntp'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-openhab:latest':
    build: True
    packages:
        'openhab':
            variable: 'VERSION_OPENHAB'
            download: 'github'
            sources:
                github:
                    url: 'https://github.com/openhab/openhab/tags'
                    xpath: '//span[@class="tag-name"]'
                    regex: *REGEX_VER_3NUM_VTAG

'nfnty/arch-openhab-telldus:latest':
    build: True
    check: False

'nfnty/arch-openvpn:latest':
    build: True
    packages:
        'openvpn':
            variable: 'VERSION_OPENVPN'
            download: 'core'
            sources:
                upstream:
                    url: 'https://openvpn.net/index.php/open-source/downloads.html'
                    xpath: '(//span[text()="Source Tarball (gzip)"]/../following-sibling::td)[1]//strong'
                    regex: '^openvpn-(\d+\.\d+\.\d+).tar.gz$'
                archlinux:
                    url: 'https://www.archlinux.org/packages/core/x86_64/openvpn'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-postgresql:latest':
    build: True
    packages:
        'postgresql':
            variable: 'VERSION_POSTGRESQL'
            download: 'extra'
            sources:
                upstream:
                    url: 'http://www.postgresql.org/ftp/source'
                    xpath: '//h2[text()="Directories"]/following-sibling::div//tr/td/a[2]'
                    regex: *REGEX_VER_3NUM_VTAG
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/postgresql'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-powerdns-recursor:latest':
    build: True
    packages:
        'powerdns-recursor':
            variable: 'VERSION_POWERDNS_RECURSOR'
            download: 'community'
            sources:
                upstream:
                    url: 'https://downloads.powerdns.com/releases/'
                    xpath: '//div[@class="list"]/table/tbody//a[contains(text(), "pdns-recursor")]'
                    regex: '^pdns-recursor-(\d+\.\d+\.\d+)\.tar\.bz2'
                github:
                    url: 'https://github.com/PowerDNS/pdns/tags'
                    xpath: '//span[@class="tag-name"]'
                    regex: '^rec-(\d+\.\d+\.\d+)$'
                archlinux:
                    url: 'https://www.archlinux.org/packages/community/x86_64/powerdns-recursor'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-samba:latest':
    build: True
    packages:
        'samba':
            variable: 'VERSION_SAMBA'
            download: 'extra'
            sources:
                upstream:
                    url: 'https://download.samba.org/pub/samba/stable'
                    xpath: '//td/a[contains(text(), "samba-")]'
                    regex: '^samba-(\d+\.\d+\.\d+(?:\w+)?).tar.gz$'
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/samba'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-transmission:latest':
    build: True
    packages:
        'transmission-cli':
            variable: 'VERSION_TRANSMISSION'
            download: 'extra'
            sources:
                upstream:
                    url: 'http://download.transmissionbt.com/files'
                    xpath: '//a[contains(text(), "transmission-")]'
                    regex: '^transmission-(\d+\.\d+?).tar.xz$'
                archlinux:
                    url: 'https://www.archlinux.org/packages/extra/x86_64/transmission-cli'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-pimd:latest':
    build: True
    packages:
        'pimd':
            variable: 'VERSION_PIMD'
            download: 'nfnty'
            sources:
                github:
                    url: 'https://github.com/troglobit/pimd/tags'
                    xpath: '//span[@class="tag-name"]'
                    regex: *REGEX_VER_3NUM

'nfnty/arch-avahi:latest':
    build: True
    packages:
        'avahi':
            variable: 'VERSION_AVAHI'
            download: 'extra'
            sources:
                upstream:
                    url: 'http://www.avahi.org/wiki/DownloadAvahi'
                    xpath: '//p[contains(text(), "latest version")]/a'
                    regex: *REGEX_VER_3NUM

'nfnty/arch-plex:latest':
    build: False
    packages:
        'plexmediaserver':
            variable: 'VERSION_PLEX'
            download: 'upstream'
            sources:
                upstream:
                    url: 'https://plex.tv/downloads'
                    xpath: '//span[@class="linux fedora"]/..//text()[contains(., "Version")]'
                    regex: '(\d+\.\d+\.\d+\.\d+\.\d+-[0-9a-f]+)'

'nfnty/arch-nodejs:latest':
    build: False
    packages:
        'nodejs':
            variable: 'VERSION_NODEJS'
            download: 'community'
            sources:
                archlinux:
                    url: 'https://www.archlinux.org/packages/community/x86_64/nodejs'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-npm:latest':
    build: False
    packages:
        'npm':
            variable: 'VERSION_NPM'
            download: 'community'
            sources:
                archlinux:
                    url: 'https://www.archlinux.org/packages/community/x86_64/npm'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-letsencrypt:latest':
    build: True
    packages:
        'letsencrypt':
            variable: 'VERSION_LETSENCRYPT'
            download: 'community'
            sources:
                archlinux:
                    url: 'https://www.archlinux.org/packages/community/any/letsencrypt'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH

'nfnty/arch-owncloud:latest':
    build: True
    packages:
        'owncloud':
            variable: 'VERSION_OWNCLOUD'
            download: 'community'
            sources:
                archlinux:
                    url: 'https://www.archlinux.org/packages/community/any/owncloud'
                    xpath: *XPATH_ARCH
                    attribute: *ATTRIBUTE_ARCH
